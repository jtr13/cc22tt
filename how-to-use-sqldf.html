<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 22 How to use sqldf | Community Contributions for EDAV Fall 2022 Tues/Thurs</title>
<meta name="description" content="Conor Ryan library(sqldf) library(tidyverse)  22.1 Motivation sqldf is a library that lets you work with dataframes as if they were database tables, such that you can query them and do whatever...">
<meta name="generator" content="bookdown 0.30 with bs4_book()">
<meta property="og:title" content="Chapter 22 How to use sqldf | Community Contributions for EDAV Fall 2022 Tues/Thurs">
<meta property="og:type" content="book">
<meta property="og:description" content="Conor Ryan library(sqldf) library(tidyverse)  22.1 Motivation sqldf is a library that lets you work with dataframes as if they were database tables, such that you can query them and do whatever...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 22 How to use sqldf | Community Contributions for EDAV Fall 2022 Tues/Thurs">
<meta name="twitter:description" content="Conor Ryan library(sqldf) library(tidyverse)  22.1 Motivation sqldf is a library that lets you work with dataframes as if they were database tables, such that you can query them and do whatever...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.1/transition.js"></script><script src="libs/bs3compat-0.4.1/tabs.js"></script><script src="libs/bs3compat-0.4.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="libs/plotly-binding-4.10.1/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script><link href="libs/visjs-7.4.9/vis-timeline-graph2d.min.css" rel="stylesheet">
<script src="libs/visjs-7.4.9/vis-timeline-graph2d.min.js"></script><link href="libs/timeline-0.4/timevis.css" rel="stylesheet">
<script src="libs/timevis-binding-2.1.0/timevis.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Community Contributions for EDAV Fall 2022 Tues/Thurs</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Welcome!</a></li>
<li><a class="" href="community-contribution.html"><span class="header-section-number">2</span> Community Contribution</a></li>
<li><a class="" href="github-submission-instructions.html"><span class="header-section-number">3</span> GitHub submission instructions</a></li>
<li><a class="" href="sample-project.html"><span class="header-section-number">4</span> Sample project</a></li>
<li class="book-part">Cheatsheets</li>
<li><a class="" href="r-window-functions-cheatsheet.html"><span class="header-section-number">6</span> R window functions cheatsheet</a></li>
<li><a class="" href="rmd-chunk-option-cheat-sheet.html"><span class="header-section-number">7</span> Rmd chunk option cheat sheet</a></li>
<li><a class="" href="helpful-ggplot2-extensions-cheatsheet.html"><span class="header-section-number">8</span> Helpful ggplot2 Extensions Cheatsheet</a></li>
<li><a class="" href="commonly-used-graph-cheatcheet.html"><span class="header-section-number">9</span> Commonly-used graph cheatcheet</a></li>
<li><a class="" href="git-and-version-control.html"><span class="header-section-number">10</span> Git and version control</a></li>
<li><a class="" href="useful-plots-for-bioinfomatics-in-r.html"><span class="header-section-number">11</span> Useful plots for Bioinfomatics in R</a></li>
<li><a class="" href="different-ways-to-create-world-map-in-r.html"><span class="header-section-number">12</span> Different ways to create world map in R</a></li>
<li><a class="" href="color-in-r-python-and-jshtmlcss.html"><span class="header-section-number">13</span> Color in R, Python, and JS/HTML/CSS</a></li>
<li><a class="" href="color-palettes-for-data-visualization.html"><span class="header-section-number">14</span> Color Palettes for Data Visualization</a></li>
<li><a class="" href="data-visualization-using-seaborn.html"><span class="header-section-number">15</span> Data visualization using Seaborn</a></li>
<li><a class="" href="machine-learning-cheatsheet-for-r-and-python.html"><span class="header-section-number">16</span> Machine Learning Cheatsheet for R and Python</a></li>
<li><a class="" href="data-visualization-with-r-ggplot2-vs.-matlab.html"><span class="header-section-number">17</span> Data Visualization with R ggplot2 vs. Matlab</a></li>
<li><a class="" href="ggplot2-plots-in-python-cheat-sheet-tutorial.html"><span class="header-section-number">18</span> Ggplot2 plots in python cheat sheet tutorial</a></li>
<li><a class="" href="model-evaluation-selection-visualization-with-easystats.html"><span class="header-section-number">19</span> Model evaluation, selection &amp; visualization with easystats</a></li>
<li class="book-part">Tutorials</li>
<li><a class="" href="preprocessing-and-visualization-of-time-series-data.html"><span class="header-section-number">21</span> Preprocessing and Visualization of Time Series Data</a></li>
<li><a class="active" href="how-to-use-sqldf.html"><span class="header-section-number">22</span> How to use sqldf</a></li>
<li><a class="" href="googlevis-in-r.html"><span class="header-section-number">23</span> googleVis in R</a></li>
<li><a class="" href="tutorial-for-vector-fields-in-r.html"><span class="header-section-number">24</span> Tutorial for vector fields in r</a></li>
<li><a class="" href="data-cleaning-with-r.html"><span class="header-section-number">25</span> Data cleaning with r</a></li>
<li><a class="" href="introduction-to-shiny-web-apps.html"><span class="header-section-number">26</span> Introduction to Shiny Web Apps</a></li>
<li><a class="" href="python-missingno-library-tutorial.html"><span class="header-section-number">27</span> Python missingno library tutorial</a></li>
<li><a class="" href="data-explorer-tutorial-and-automation.html"><span class="header-section-number">28</span> Data Explorer Tutorial and Automation</a></li>
<li><a class="" href="d-visualization-in-r.html"><span class="header-section-number">29</span> 3D Visualization in R</a></li>
<li><a class="" href="visualizing-time-series-data.html"><span class="header-section-number">30</span> Visualizing Time Series Data</a></li>
<li><a class="" href="igraph-in-r.html"><span class="header-section-number">31</span> igraph in r</a></li>
<li><a class="" href="geo-mapping-coordinate-extraction-using-api-calls.html"><span class="header-section-number">32</span> Geo-Mapping Coordinate Extraction Using API Calls</a></li>
<li><a class="" href="edav-garden.html"><span class="header-section-number">33</span> EDAV Garden</a></li>
<li><a class="" href="using-raster-data-in-r.html"><span class="header-section-number">34</span> Using raster data in R</a></li>
<li><a class="" href="make-geographical-maps-with-different-packages.html"><span class="header-section-number">35</span> Make Geographical Maps with Different Packages</a></li>
<li><a class="" href="how-to-obtain-data-from-api-and-process-raw-json-data.html"><span class="header-section-number">36</span> How to obtain data from API and process raw JSON data</a></li>
<li><a class="" href="sample-statistic-tutorial.html"><span class="header-section-number">37</span> Sample Statistic Tutorial</a></li>
<li><a class="" href="data-cleaning-tutorial.html"><span class="header-section-number">38</span> Data cleaning tutorial</a></li>
<li class="book-part">Interview Prep</li>
<li><a class="" href="ten-interview-questions-and-answers.html"><span class="header-section-number">40</span> Ten interview questions and answers</a></li>
<li><a class="" href="data-science-internship-search-survival-guide.html"><span class="header-section-number">41</span> Data science internship search survival guide</a></li>
<li><a class="" href="data-visualization-interview-questions-sample.html"><span class="header-section-number">42</span> Data visualization interview questions sample</a></li>
<li class="book-part">Case Studies</li>
<li><a class="" href="benford-case-study.html"><span class="header-section-number">44</span> Benford Case Study</a></li>
<li class="book-part">Appendices</li>
<li><a class="" href="github-initial-setup.html"><span class="header-section-number">45</span> Github initial setup</a></li>
<li><a class="" href="tutorial-for-pull-request-mergers.html"><span class="header-section-number">46</span> Tutorial for pull request mergers</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/jtr13/cc22tt">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="how-to-use-sqldf" class="section level1" number="22">
<h1>
<span class="header-section-number">22</span> How to use <code>sqldf</code><a class="anchor" aria-label="anchor" href="#how-to-use-sqldf"><i class="fas fa-link"></i></a>
</h1>
<p>Conor Ryan</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ggrothendieck/sqldf">sqldf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<div id="motivation-1" class="section level2" number="22.1">
<h2>
<span class="header-section-number">22.1</span> Motivation<a class="anchor" aria-label="anchor" href="#motivation-1"><i class="fas fa-link"></i></a>
</h2>
<p><code>sqldf</code> is a library that lets you work with dataframes as if they were database tables, such that you can query them and do whatever SQL-style manipulation you want, without worrying about the logistics of managing any databases. It can be useful for various dataframe manipulations, as we often need to do when preparing data for visualization.</p>
<p>There are a few reasons why I thought the library could use a tutorial:</p>
<ul>
<li>Its <a href="https://github.com/ggrothendieck/sqldf#For_Those_New_to_R">Github page</a> is kind of a mess, and its <a href="https://cran.r-project.org/web/packages/sqldf/sqldf.pdf">official CRAN documentation</a> is not particularly user-friendly.</li>
<li>This is a pretty cool tool when you think about it: with no overhead or extra work, we can just call SQL on a dataframe.</li>
<li>The option to use SQL is incredibly useful when dealing with working in many languages. If I need a quick R visualization but was just working with Python, it might be easier to just manipulate my data via SQL rather than figure out the exact R syntax that would do the same thing.</li>
<li>Certain data manipulation is just more suited for SQL syntax, like complicated left joins and window functions.</li>
<li>When the scale of our data gets too large for memory, this library offers some impressive advantages. Even if you can load the large dataset into memory, doing so will be slow; it is way faster to do your initial manipulation (like filtering the data down 100-fold) through this library, after which it is more reasonable to deal with the resulting dataframe.</li>
<li>This approach is a significant improvement over something like <code>dbplyr</code> and the <code>knitr</code> SQL engine. Such an approach still requires manual management of connections and tables. Additionally, <code>knitr</code> is hardly suited for non-report-style work in R. <code>sqldf</code> is usable in a wider variety of scenarios.</li>
</ul>
</div>
<div id="usage" class="section level2" number="22.2">
<h2>
<span class="header-section-number">22.2</span> Usage<a class="anchor" aria-label="anchor" href="#usage"><i class="fas fa-link"></i></a>
</h2>
<div id="basics" class="section level3" number="22.2.1">
<h3>
<span class="header-section-number">22.2.1</span> Basics<a class="anchor" aria-label="anchor" href="#basics"><i class="fas fa-link"></i></a>
</h3>
<p>Once you’ve installed the <code>sqldf</code>, it really is as easy as loading the library and writing some SQL:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/sqldf.html">sqldf</a></span><span class="op">(</span><span class="st">'select * from iris'</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
<p>We did not have to create any database, load our data to any table, or cleanup the table. The package handled it all behind the scenes.</p>
<p>We can do some more realistic, basic manipulation. In R we might do:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Petal.Length</span> <span class="op">&gt;</span> <span class="fl">2.0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Sepal_Product <span class="op">=</span> <span class="va">Sepal.Length</span> <span class="op">*</span> <span class="va">Sepal.Width</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Species</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_sepal_product<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Sepal_Product</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   Species    mean_sepal_product
##   &lt;fct&gt;                   &lt;dbl&gt;
## 1 versicolor               16.5
## 2 virginica                19.7</code></pre>
<p>While in SQL we can do:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/sqldf.html">sqldf</a></span><span class="op">(</span><span class="st">'</span></span>
<span><span class="st">  select Species, avg(`Sepal.Length` * `Sepal.Width`) as mean_sepal_product</span></span>
<span><span class="st">  from iris</span></span>
<span><span class="st">  where `Petal.Length` &gt; 2.0</span></span>
<span><span class="st">  group by 1</span></span>
<span><span class="st">'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      Species mean_sepal_product
## 1 versicolor            16.5262
## 2  virginica            19.6846</code></pre>
</div>
<div id="more-advanced-sql-tasks" class="section level3" number="22.2.2">
<h3>
<span class="header-section-number">22.2.2</span> More advanced SQL tasks<a class="anchor" aria-label="anchor" href="#more-advanced-sql-tasks"><i class="fas fa-link"></i></a>
</h3>
<p>This library becomes more powerful as you use it to do things SQL is uniquely good at. For example, although a simple join on a <em>matching</em> column condition is relatively easy in R (and Python), the following sort of condition is more annoying to accomplish:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/sqldf.html">sqldf</a></span><span class="op">(</span><span class="st">'</span></span>
<span><span class="st">  select a.Species, b.Species, avg(a.`Sepal.Width`) as `a.Width.Avg`</span></span>
<span><span class="st">  from iris a</span></span>
<span><span class="st">  join iris b</span></span>
<span><span class="st">    on a.species != b.species</span></span>
<span><span class="st">    and a.`Sepal.Length` &gt; b.`Sepal.Length`</span></span>
<span><span class="st">    and a.`Sepal.Width` &lt; b.`Sepal.Width`</span></span>
<span><span class="st">  group by 1,2</span></span>
<span><span class="st">'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##      Species    Species a.Width.Avg
## 1 versicolor     setosa    2.764037
## 2 versicolor  virginica    2.738889
## 3  virginica     setosa    2.901931
## 4  virginica versicolor    2.737284</code></pre>
<p>Similarly, window functions become far more accessible through this package:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/sqldf.html">sqldf</a></span><span class="op">(</span><span class="st">'</span></span>
<span><span class="st">  select Species, avg(`Sepal.Length`) over (partition by Species order by `Sepal.Length` desc rows between unbounded preceding and current row) as running_mean</span></span>
<span><span class="st">  from iris</span></span>
<span><span class="st">'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##   Species running_mean
## 1  setosa     5.800000
## 2  setosa     5.750000
## 3  setosa     5.733333
## 4  setosa     5.675000
## 5  setosa     5.640000
## 6  setosa     5.600000</code></pre>
<p>These are unique tasks where it might even be preferable to just use SQL rather than the R dataframe manipulation. Which is fine; not every tool can do everything prefectly – SQL excels at very specific things.</p>
</div>
<div id="alternate-data-sources" class="section level3" number="22.2.3">
<h3>
<span class="header-section-number">22.2.3</span> Alternate data sources<a class="anchor" aria-label="anchor" href="#alternate-data-sources"><i class="fas fa-link"></i></a>
</h3>
<p>We also don’t have to already have the dataframe in-memory to use this library. Suppose <code>iris</code> was in a .csv on our machine:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># disabled because we were asked to not write any data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span><span class="op">(</span><span class="va">iris</span>, <span class="st">'iris.csv'</span>, sep <span class="op">=</span> <span class="st">","</span>, quote <span class="op">=</span> <span class="cn">FALSE</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>and we wanted to immediately get it into memory with a few rows filtered out:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># disabled because we were asked to not write any data</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/read.csv.sql.html">read.csv.sql</a></span><span class="op">(</span><span class="st">'iris.csv'</span>,  sql <span class="op">=</span> <span class="st">'select * from file where "Petal.Length" &gt; 2.0'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This is great because we didn’t ever have to have the “useless” version of the dataframe ever in our code; immediately we get this version that has some filtering done.</p>
<p>Or, what if the data lives as a .csv on some remote host?</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/read.csv.sql.html">read.csv.sql</a></span><span class="op">(</span></span>
<span>  <span class="st">'https://gist.githubusercontent.com/netj/8836201/raw/6f9306ad21398ea43cba4f7d537619d0e07d5ae3/iris.csv'</span>,</span>
<span>  sql <span class="op">=</span> <span class="st">'select * from file where "Petal.Length" &gt; 2.0'</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##   sepal.length sepal.width petal.length petal.width      variety
## 1          7.0         3.2          4.7         1.4 "Versicolor"
## 2          6.4         3.2          4.5         1.5 "Versicolor"
## 3          6.9         3.1          4.9         1.5 "Versicolor"
## 4          5.5         2.3          4.0         1.3 "Versicolor"
## 5          6.5         2.8          4.6         1.5 "Versicolor"
## 6          5.7         2.8          4.5         1.3 "Versicolor"</code></pre>
<p>Hopefully you can see why these options are powerful. Although <code>iris</code> is small, sometimes our data is very large, and we may not want to deal with loading many millions of rows into R if we are going to filter it down anyway. There is an example of this later under <a href="how-to-use-sqldf.html#performance">the Performance section</a>.</p>
</div>
<div id="advanced-database-usage" class="section level3" number="22.2.4">
<h3>
<span class="header-section-number">22.2.4</span> Advanced database usage<a class="anchor" aria-label="anchor" href="#advanced-database-usage"><i class="fas fa-link"></i></a>
</h3>
<p>Under the hood, <code>sqldf</code> actually loads each dataframe into a temporary database table. If we want, we can also manage the database more intelligently. This is a more contrived use case, but worth knowing. Suppose you’re dealing with a lot of data and plan to do two subsequent queries. It would be better to only read the dataframe into a table once and reuse that table. This can be accomplished via:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/sqldf.html">sqldf</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># keep iris as a table in the db</span></span></code></pre></div>
<pre><code>## &lt;SQLiteConnection&gt;
##   Path: :memory:
##   Extensions: TRUE</code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/sqldf.html">sqldf</a></span><span class="op">(</span><span class="st">'select * from iris'</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># iris now loaded as a table. can reuse it.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/sqldf.html">sqldf</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># connection closed and iris table deleted</span></span></code></pre></div>
<pre><code>## NULL</code></pre>
<p>You can also just pass any database administrative command to the above function as well. For example, you could manage the entire database (create new schemas, tables, adjust permissions) if you really wanted to. Although doing so in a more appropriate tool might be worth considering.</p>
</div>
</div>
<div id="performance" class="section level2" number="22.3">
<h2>
<span class="header-section-number">22.3</span> Performance<a class="anchor" aria-label="anchor" href="#performance"><i class="fas fa-link"></i></a>
</h2>
<p>Certain tasks actually end up more optimal if done through <code>sqldf</code>. For example, the following arbitrarily large join, which fans out to nearly a billion rows, took roughly 30 seconds on my laptop to finish. (Although the below task is nonsense, in real data, one may come across a use case that actually needs to do something similar.)</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/sqldf.html">sqldf</a></span><span class="op">(</span><span class="st">'</span></span>
<span><span class="st">  select count(*)</span></span>
<span><span class="st">  from iris a</span></span>
<span><span class="st">  join iris b using (species)</span></span>
<span><span class="st">  join iris c using (species)</span></span>
<span><span class="st">  join iris d using (species)</span></span>
<span><span class="st">  join iris e using (species)</span></span>
<span><span class="st">'</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    count(*)
## 1 937500000</code></pre>
<p>The following R equivalent, which only does the third ‘join’, took longer than all four took in SQL. To preserve my computer, I did not attempt the fourth <code>merge</code> below (commented out).</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">iris</span>, by<span class="op">=</span><span class="st">"Species"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">iris</span>, by<span class="op">=</span><span class="st">"Species"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">iris</span>, by<span class="op">=</span><span class="st">"Species"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co">#merge(iris, by="Species") |&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 18750000</code></pre>
<p>This library also becomes helpful when dealing with large datasets on disk. For example, the below arbitrary .csv was ~600MB (I did not include the file with this project, but feel free to try it with your own large file). Because the below does not require we load the entire file into R first, it finished in about 30 seconds.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># disabled because I cannot provide this (intentionally) large file</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/read.csv.sql.html">read.csv.sql</a></span><span class="op">(</span></span>
<span>  <span class="st">'~/Downloads/star2002-1.csv'</span>,</span>
<span>  sql<span class="op">=</span><span class="st">'select `X1`, avg(`X807`) from file where `X4518` &gt; 5500 group by 1'</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This is a worthwhile improvement; the below R equivalent completed in 45 seconds.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># disabled because I cannot provide this (intentionally) large file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'~/Downloads/star2002-1.csv'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">X4518</span> <span class="op">&gt;</span> <span class="fl">5500</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">X1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>some_avg<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">X807</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This difference becomes more meaningful as your dataset’s size increases relative to your machine’s memory. Once the file is several GB, preprocessing in a temporary database table becomes increasingly more efficient relative to pure R. We observed a marginal version of this optimization above. This functionality is especially useful if we know we will never need to refer back to the full file (meaning we will only use e.g. the transformed version as above).</p>
</div>
<div id="combining-with-ggplot" class="section level2" number="22.4">
<h2>
<span class="header-section-number">22.4</span> Combining with ggplot<a class="anchor" aria-label="anchor" href="#combining-with-ggplot"><i class="fas fa-link"></i></a>
</h2>
<p>We can also combine <code>sqldf</code> manipulations with <code>ggplot</code> to easily make visualizations. When we use <code>sqldf</code> in the scenarios it excels at, as outlined above, this becomes powerful. There are infinite combinations here, so here is one simple illustrative example:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sqldf/man/sqldf.html">sqldf</a></span><span class="op">(</span><span class="st">'</span></span>
<span><span class="st">      select Species, avg(`Sepal.Width`) as avg_width</span></span>
<span><span class="st">      from iris</span></span>
<span><span class="st">      group by 1</span></span>
<span><span class="st">'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">Species</span>, <span class="va">avg_width</span><span class="op">)</span>, y<span class="op">=</span><span class="va">avg_width</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">'identity'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">'Species'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="how_to_use_sqldf_files/figure-html/unnamed-chunk-15-1.png" width="80%" style="display: block; margin: auto;"></div>
</div>
<div id="conclusion-1" class="section level2" number="22.5">
<h2>
<span class="header-section-number">22.5</span> Conclusion<a class="anchor" aria-label="anchor" href="#conclusion-1"><i class="fas fa-link"></i></a>
</h2>
<p><code>sqldf</code> is an important option to have available when manipulating data. To be clear, it is not a replacement for knowing how to use R in general. One should restrict themselves to using <code>sqldf</code> only when doing so is uniquely advantageous to SQL-style work, or if they don’t want to deal with writing perfect R. The above guide should be useful to anyone new to the library as to exactly which scenarios one might opt to use it in.</p>
<p>Personally, I’m glad I chose to do a deep dive into this library and create this guide. It was educational in many ways, like: learning more about databases, understanding how R can blend with SQL, and elucidating the things that R vs. SQL each excel at. I will certainly be be referring back to this document, as I think it makes it easy to review exactly how to quickly use the library, without getting too in-the-weeds of all its nuts and bolts (as much of its existing documentation does, in my opinion). One thing I’d like to dedicate more effort to next time is exactly replicating complex SQL commands in R; knowing how to do so will likely be useful at some point, even if not practical right now. Finally, I wish I had known about this library sooner, as I know that it will for sure optimize parts of my workflow going foward.</p>
</div>
<div id="references" class="section level2" number="22.6">
<h2>
<span class="header-section-number">22.6</span> References<a class="anchor" aria-label="anchor" href="#references"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://github.com/ggrothendieck/sqldf" class="uri">https://github.com/ggrothendieck/sqldf</a></p>
<p><a href="https://cran.r-project.org/web/packages/sqldf/index.html" class="uri">https://cran.r-project.org/web/packages/sqldf/index.html</a></p>
<p><a href="https://www.geeksforgeeks.org/window-functions-in-sql/" class="uri">https://www.geeksforgeeks.org/window-functions-in-sql/</a></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="preprocessing-and-visualization-of-time-series-data.html"><span class="header-section-number">21</span> Preprocessing and Visualization of Time Series Data</a></div>
<div class="next"><a href="googlevis-in-r.html"><span class="header-section-number">23</span> googleVis in R</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#how-to-use-sqldf"><span class="header-section-number">22</span> How to use sqldf</a></li>
<li><a class="nav-link" href="#motivation-1"><span class="header-section-number">22.1</span> Motivation</a></li>
<li>
<a class="nav-link" href="#usage"><span class="header-section-number">22.2</span> Usage</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#basics"><span class="header-section-number">22.2.1</span> Basics</a></li>
<li><a class="nav-link" href="#more-advanced-sql-tasks"><span class="header-section-number">22.2.2</span> More advanced SQL tasks</a></li>
<li><a class="nav-link" href="#alternate-data-sources"><span class="header-section-number">22.2.3</span> Alternate data sources</a></li>
<li><a class="nav-link" href="#advanced-database-usage"><span class="header-section-number">22.2.4</span> Advanced database usage</a></li>
</ul>
</li>
<li><a class="nav-link" href="#performance"><span class="header-section-number">22.3</span> Performance</a></li>
<li><a class="nav-link" href="#combining-with-ggplot"><span class="header-section-number">22.4</span> Combining with ggplot</a></li>
<li><a class="nav-link" href="#conclusion-1"><span class="header-section-number">22.5</span> Conclusion</a></li>
<li><a class="nav-link" href="#references"><span class="header-section-number">22.6</span> References</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/jtr13/cc22tt/blob/main/how_to_use_sqldf.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/jtr13/cc22tt/edit/main/how_to_use_sqldf.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Community Contributions for EDAV Fall 2022 Tues/Thurs</strong>" was written by . It was last built on 2022-11-16.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
